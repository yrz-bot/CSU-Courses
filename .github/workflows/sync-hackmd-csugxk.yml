name: sync hackmd csugxk

on:
  schedule:
    # 04:00 China time (UTC+8) => 20:00 UTC (previous day)
    - cron: "0 20 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: sync-hackmd-csugxk
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download HackMD markdown and write to 公选课/README.md
        shell: bash
        run: |
          set -euo pipefail
          URL="https://hackmd.io/@iljy/csugxk/download"
          TARGET="公选课/README.md"

          # Fail fast if path doesn't exist (prevents unicode/path surprises)
          if [ ! -f "$TARGET" ]; then
            echo "ERROR: Target file does not exist: $TARGET"
            echo "README.md candidates:"
            find . -maxdepth 5 -name README.md -print
            exit 3
          fi

          tmp="$(mktemp)"
          curl -fsSL "$URL" -o "$tmp"

          # Sanity check: avoid committing HTML pages
          if head -n 5 "$tmp" | grep -qi "<!doctype html\|<html"; then
            echo "Downloaded content looks like HTML, aborting."
            head -n 20 "$tmp"
            exit 2
          fi

          cat "$tmp" > "$TARGET"

      - name: Create or update PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/sync-hackmd-csugxk
          base: main
          title: "Sync 公选课/README.md from HackMD"
          body: |
            This PR syncs `公选课/README.md` from HackMD:
            - Source: https://hackmd.io/@iljy/csugxk
          labels: |
            documentation
            automated
          commit-message: "chore(docs): sync 公选课/README.md from HackMD"
